<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    .container {
        position: relative;
        border: 1px solid #f1f1f1;
        display: block;
        margin: 50px auto;
        height: 500px;
        width: 750px;
    }

    .backend {
        position: absolute;
        z-index: 1;
    }

    .clip {
        position: absolute;
        z-index: 2;
    }

</style>
<body>
<div class="container">
    <canvas id="backImg" height="500" width="750" class="backend"></canvas>
    <!--<canvas id="clip" height="500" width="750" class="clip"></canvas>-->
</div>
<input type="file" id="upload">no multiple
</body>
<script>
    class ImageContain {
        constructor() {
            this.el = document.querySelector('#upload');
            let canvas = this.canvas = document.querySelector('#backImg');
            this.ctx = canvas.getContext('2d');
            this.cvsWidth = canvas.width;
            this.cvsHeight = canvas.height;
            //动画数据相关
            this.data = {
                firstRender: true,
                scale: 1,
                action: 'view',
                offsetX: 0,
                offsetY: 0,
                drawX: 0,
                drawY: 0,
                drawHeight: 0,
                drawWidth: 0
            };
            this._init();
        }

        _setData(key, value) {
            this.data[key] = value;
        }

        _getData(key) {
            return this.data[key];
        }

        _init() {
            this._changeCursor();
            this._bindEvent();
        }

        _bindEvent() {
            let that = this,
                startX,
                startY;

            this.el.addEventListener('change', function () {
                Array.prototype.forEach.call(this.files, function (item) {
                    let reader = new FileReader();
                    let url = reader.readAsDataURL(item);
                    reader.onload = function (event) {
                        that._loadImg(event.target.result)
                    }
                });
            }, false);

            this.canvas.addEventListener('mousedown', function (event) {
                that._setData('action', 'movestart');
                startX = event.offsetX;
                startY = event.offsetY;
            }, false);
            this.canvas.addEventListener('mousemove', function (event) {
                that._moveImg(startX, startY, event);
            }, false);
            this.canvas.addEventListener('mouseup', function (event) {
                that._setData('action', 'moveend');
                that._moveImg(startX, startY, event);
                that._setData('action', 'view');
            }, false);

            this.canvas.addEventListener('mousewheel', function (event) {
                that._setData('action', 'scale');
                that._scaleImg(event.wheelDelta);
            }, false);
        }

        _scaleImg(wheelDelta) {
            if (this._getData('action') !== 'scale') return;
            let scale = this._getData('scale');
            scale += (wheelDelta / 600);
            if (scale < 1) scale = 1;
            this._setData('scale', scale);
            this._drawImg();
        }

        _moveImg(startX, startY, event) {
            if (!this._getData('action').match(/^move/)) return;
            let eventX = event.offsetX,
                eventY = event.offsetY;
            this._setData('offsetX', startX - eventX);
            this._setData('offsetY', startY - eventY);
            this._drawImg();
        }

        _loadImg(url) {
            let that = this;
            let img = document.createElement('img');
            img.src = url;
            img.onload = () => {
                that.image = img;
                that._drawImg();
            };
        }

        _changeCursor(type) {
            if (type === 'cut') {
                this.canvas.style.cursor = 'crosshair';
            } else {
                this.canvas.style.cursor = 'move';
            }
        }

        _drawImg() {
            let img = this.image;
            let temp;
            if (this._getData('firstRender')) {
                temp = this._calFirstRender(img.width, img.height);
                this._setData('firstRender', false);
            } else {
                temp = this._calImgSize(img.width, img.height);
            }
            this.ctx.clearRect(0, 0, this.cvsWidth, this.cvsHeight);
            this.ctx.fillStyle = 'rgba(0,0,0,.5)';
            this.ctx.fillRect(0, 0, this.cvsWidth, this.cvsHeight);
            this.ctx.fillStyle = '#fff';
            this.ctx.fillRect(temp.x, temp.y, temp.w, temp.h);
            this.ctx.drawImage(img, temp.x, temp.y, temp.w, temp.h);
        }

        //第一次渲染
        _calFirstRender(width, height) {
            let cvsWidth = this.cvsWidth,
                cvsHeight = this.cvsHeight,
                imgWidth = width,
                imgHeight = height,
                drawX = 0,
                drawY = 0,
                drawHeight,
                drawWidth;
            if (imgWidth > imgHeight) {
                drawWidth = cvsWidth;
                drawHeight = (drawWidth / imgWidth) * imgHeight;
                drawY = (cvsHeight - drawHeight) / 2;
            } else {
                drawHeight = cvsHeight;
                drawWidth = (drawHeight / imgHeight) * imgWidth;
                drawX = (cvsWidth - drawWidth) / 2;
            }
            this._setData('drawX', drawX);
            this._setData('drawY', drawY);
            this._setData('drawHeight', drawHeight);
            this._setData('drawWidth', drawWidth);

            return {
                x: drawX,
                y: drawY,
                w: drawWidth,
                h: drawHeight
            }
        }

        //计算
        _calImgSize(width, height) {
            let scale = this._getData('scale'),
                offsetX = this._getData('offsetX'),
                offsetY = this._getData('offsetY'),
                drawX = this._getData('drawX'),
                drawY = this._getData('drawY'),
                drawHeight = this._getData('drawHeight'),
                drawWidth = this._getData('drawWidth');

            if (this._getData('action') === 'scale' && scale) {
                drawX -= (scale - 1) * drawWidth / 2;
                drawY -= (scale - 1) * drawHeight / 2;
                drawWidth = drawWidth * scale;
                drawHeight = drawHeight * scale;
                this._setData('drawX', drawX);
                this._setData('drawY', drawY);
                this._setData('drawHeight', drawHeight);
                this._setData('drawWidth', drawWidth);
            } else if (this._getData('action').match(/^move/) && (offsetX || offsetY)) {
                drawX -= offsetX;
                drawY -= offsetY;
                if (this._getData('action') === 'moveend') {
                    this._setData('drawX', drawX);
                    this._setData('drawY', drawY);
                }
            }
            return {
                x: drawX,
                y: drawY,
                w: drawWidth,
                h: drawHeight
            }
        }
    }
    new ImageContain();
</script>
</html>